<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configura√ß√µes - U.M.C.A.D</title>
  
  <!-- Manifest para PWA e notifica√ß√µes push -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Meta tags para PWA -->
  <meta name="theme-color" content="#29b6f6">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="U.M.C.A.D">
  
  <!-- √çcones -->
  <link rel="icon" type="image/png" sizes="256x256" href="/imagens/icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192x192.png">
  <link rel="apple-touch-icon" href="/imagens/icon.png">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="./config.css">
</head>
<body>
  <div class="main-container">
    <!-- Navega√ß√£o -->
    <div class="nav-wrapper">
      <div class="logo">
        U.M.C.A.D<span>‚öôÔ∏è</span> 
      </div>
      <nav>
        <a href="/">In√≠cio</a>
        <a href="/dados">Dados</a>
      </nav>
    </div>

    <!-- Container de configura√ß√µes -->
    <div class="config-container">
      <div class="config-header">
        <h1>‚öôÔ∏è Configura√ß√µes</h1>
        <p>Personalize suas prefer√™ncias de notifica√ß√£o e gerencie sua conta</p>
      </div>

      <form id="configForm">
        <!-- Se√ß√£o de Notifica√ß√µes Push -->
        <div class="config-section">
          <h2>üîî Notifica√ß√µes Push</h2>
          <p>Configure quando voc√™ deseja receber notifica√ß√µes do sistema de monitoramento.</p>
          
          <div class="checkbox-group">
            <input type="checkbox" id="enableNotifications" name="enableNotifications">
            <label for="enableNotifications">Ativar notifica√ß√µes push</label>
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="dailyReports" name="dailyReports">
            <label for="dailyReports">Receber relat√≥rios di√°rios</label>
          </div>
        </div>

        <!-- Se√ß√£o de Configura√ß√µes de Umidade -->
        <div class="config-section">
          <h2>üíß Configura√ß√µes de Umidade</h2>
          <p>Defina os limites de umidade do ar e do solo para receber alertas.</p>
          
          <div class="checkbox-group">
            <input type="checkbox" id="humidityAlertsEnabled" name="humidityAlertsEnabled">
            <label for="humidityAlertsEnabled">Ativar alertas de umidade</label>
          </div>

          <div class="form-group">
            <label for="humidityMin">Umidade m√≠nima do ar (%)</label>
            <div class="form-row">
              <input type="range" id="humidityMin" name="humidityMin" min="0" max="100" value="30" class="form-control">
              <span class="range-value" id="humidityMinValue">30%</span>
            </div>
            <small style="color: #b0b0b0;">Receber alerta quando a umidade do ar estiver abaixo deste valor</small>
          </div>

          <div class="form-group">
            <label for="humidityMax">Umidade m√°xima do ar (%)</label>
            <div class="form-row">
              <input type="range" id="humidityMax" name="humidityMax" min="0" max="100" value="80" class="form-control">
              <span class="range-value" id="humidityMaxValue">80%</span>
            </div>
            <small style="color: #b0b0b0;">Receber alerta quando a umidade do ar estiver acima deste valor</small>
          </div>

          <div class="form-group">
            <label for="soilHumidityMin">Umidade m√≠nima do solo (%)</label>
            <div class="form-row">
              <input type="range" id="soilHumidityMin" name="soilHumidityMin" min="0" max="100" value="20" class="form-control">
              <span class="range-value" id="soilHumidityMinValue">20%</span>
            </div>
            <small style="color: #b0b0b0;">Receber alerta quando a umidade do solo estiver abaixo deste valor</small>
          </div>

          <div class="form-group">
            <label for="soilHumidityMax">Umidade m√°xima do solo (%)</label>
            <div class="form-row">
              <input type="range" id="soilHumidityMax" name="soilHumidityMax" min="0" max="100" value="90" class="form-control">
              <span class="range-value" id="soilHumidityMaxValue">90%</span>
            </div>
            <small style="color: #b0b0b0;">Receber alerta quando a umidade do solo estiver acima deste valor</small>
          </div>
        </div>

        <!-- Se√ß√£o de Configura√ß√µes de Temperatura -->
        <div class="config-section">
          <h2>üå°Ô∏è Configura√ß√µes de Temperatura</h2>
          <p>Defina os limites de temperatura para receber alertas (0¬∞C a 50¬∞C).</p>
          
          <div class="checkbox-group">
            <input type="checkbox" id="temperatureAlertsEnabled" name="temperatureAlertsEnabled">
            <label for="temperatureAlertsEnabled">Ativar alertas de temperatura</label>
          </div>

          <div class="form-group">
            <label for="temperatureMin">Temperatura m√≠nima (¬∞C)</label>
            <div class="form-row">
              <input type="range" id="temperatureMin" name="temperatureMin" min="0" max="50" value="10" class="form-control">
              <span class="range-value" id="temperatureMinValue">10¬∞C</span>
            </div>
            <small style="color: #b0b0b0;">Receber alerta quando a temperatura estiver abaixo deste valor</small>
          </div>

          <div class="form-group">
            <label for="temperatureMax">Temperatura m√°xima (¬∞C)</label>
            <div class="form-row">
              <input type="range" id="temperatureMax" name="temperatureMax" min="0" max="50" value="35" class="form-control">
              <span class="range-value" id="temperatureMaxValue">35¬∞C</span>
            </div>
            <small style="color: #b0b0b0;">Receber alerta quando a temperatura estiver acima deste valor</small>
          </div>
        </div>

        <!-- Se√ß√£o de Configura√ß√µes de Chuva -->
        <div class="config-section">
          <h2>üåßÔ∏è Configura√ß√µes de Chuva</h2>
          <p>Configure alertas relacionados √† detec√ß√£o de chuva.</p>
          
          <div class="checkbox-group">
            <input type="checkbox" id="rainAlertsEnabled" name="rainAlertsEnabled">
            <label for="rainAlertsEnabled">Ativar alertas de chuva</label>
          </div>

          <div class="checkbox-group">
            <input type="checkbox" id="rainStartAlert" name="rainStartAlert">
            <label for="rainStartAlert">Notificar quando come√ßar a chover</label>
          </div>

          <div class="checkbox-group">
            <input type="checkbox" id="rainStopAlert" name="rainStopAlert">
            <label for="rainStopAlert">Notificar quando parar de chover</label>
          </div>

          <div class="form-group">
            <label for="noRainDays">Dias sem chuva para alerta</label>
            <div class="form-row">
              <input type="range" id="noRainDays" name="noRainDays" min="1" max="30" value="7" class="form-control">
              <span class="range-value" id="noRainDaysValue">7 dias</span>
            </div>
            <small style="color: #b0b0b0;">Receber alerta ap√≥s este n√∫mero de dias consecutivos sem chuva</small>
          </div>
        </div>

        <!-- Se√ß√£o de Configura√ß√µes de Gases -->
        <div class="config-section">
          <h2>‚ö†Ô∏è Configura√ß√µes de Gases</h2>
          <p>Configure alertas para detec√ß√£o de gases perigosos.</p>
          
          <div class="checkbox-group">
            <input type="checkbox" id="gasAlertsEnabled" name="gasAlertsEnabled">
            <label for="gasAlertsEnabled">Ativar alertas de gases</label>
          </div>

          <div class="form-group">
            <label for="inflammableGasThreshold">Limite de g√°s inflam√°vel (%)</label>
            <div class="form-row">
              <input type="range" id="inflammableGasThreshold" name="inflammableGasThreshold" min="0" max="100" value="20" class="form-control">
              <span class="range-value" id="inflammableGasThresholdValue">20%</span>
            </div>
            <small style="color: #b0b0b0;">Receber alerta quando a concentra√ß√£o de g√°s inflam√°vel estiver acima deste valor</small>
          </div>

          <div class="form-group">
            <label for="toxicGasThreshold">Limite de g√°s t√≥xico (%)</label>
            <div class="form-row">
              <input type="range" id="toxicGasThreshold" name="toxicGasThreshold" min="0" max="100" value="15" class="form-control">
              <span class="range-value" id="toxicGasThresholdValue">15%</span>
            </div>
            <small style="color: #b0b0b0;">Receber alerta quando a concentra√ß√£o de g√°s t√≥xico estiver acima deste valor</small>
          </div>

          <div class="checkbox-group">
            <input type="checkbox" id="criticalGasAlert" name="criticalGasAlert">
            <label for="criticalGasAlert">Alertas cr√≠ticos para n√≠veis perigosos de gases</label>
          </div>
        </div>

        <!-- Se√ß√£o de Configura√ß√£o de Delay -->
        <div class="config-section">
          <h2>‚è±Ô∏è Delay de Registro</h2>
          <p>Defina o intervalo m√≠nimo entre os registros de dados dos sensores (10 minutos a 3 horas).</p>
          
          <div class="form-group">
            <label for="delayConfig">Intervalo de registro</label>
            <div class="form-row">
              <input type="range" id="delayConfig" name="delayConfig" min="10" max="180" value="10" class="form-control">
              <span class="range-value" id="delayConfigValue">10 minutos</span>
            </div>
            <small style="color: #b0b0b0;">Os dados dos sensores ser√£o registrados a cada X minutos.</small>
          </div>
        </div>

        <!-- Bot√µes de a√ß√£o do formul√°rio -->
        <div class="config-section">
          <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
            <button type="submit" class="btn btn-primary">üíæ Salvar Configura√ß√µes</button>
            <button type="button" id="resetBtn" class="btn btn-secondary">üîÑ Restaurar Padr√µes</button>
          </div>
        </div>
      </form>

      <!-- Se√ß√£o de Gerenciamento de Conta -->
      <div class="config-section account-management">
        <h2>üë§ Gerenciamento de Conta</h2>
        <p>Gerencie seus dados e configura√ß√µes de conta.</p>
        
        <div class="account-actions">
          <button type="button" id="clearHistoryBtn" class="btn btn-warning">
            üóëÔ∏è Apagar Hist√≥rico
          </button>

          <button type="button" id="regenerateTokenBtn" class="btn btn-primary">
             ‚ôªÔ∏è Regenerar Token
          </button>
          
          <button type="button" id="resetPasswordBtn" class="btn btn-secondary">
            üîë Redefinir Senha
          </button>
        </div>

        <!-- Bot√£o de excluir conta (centralizado e em vermelho) -->
        <div class="delete-account-container">
          <button type="button" id="deleteAccountBtn" class="btn btn-danger">
            ‚ùå Excluir Conta
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toastContainer"></div>

  <script>
    // Configura√ß√µes padr√£o
    const defaultSettings = {
      enableNotifications: true,
      dailyReports: true,
      humidityAlertsEnabled: true,
      humidityMin: 30,
      humidityMax: 80,
      soilHumidityMin: 20,
      soilHumidityMax: 90,
      temperatureAlertsEnabled: true,
      temperatureMin: 10,
      temperatureMax: 35,
      rainAlertsEnabled: true,
      rainStartAlert: true,
      rainStopAlert: false,
      noRainDays: 7,
      gasAlertsEnabled: true,
      inflammableGasThreshold: 20,
      toxicGasThreshold: 15,
      criticalGasAlert: true,
      delayConfig: 10
    };

    // Fun√ß√£o para mostrar toast
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      
      const container = document.getElementById('toastContainer');
      container.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => container.removeChild(toast), 300);
      }, 3000);
    }

    // Fun√ß√£o para atualizar valores dos ranges
    function updateRangeValues() {
      // Umidade
      document.getElementById('humidityMinValue').textContent = document.getElementById('humidityMin').value + '%';
      document.getElementById('humidityMaxValue').textContent = document.getElementById('humidityMax').value + '%';
      document.getElementById('soilHumidityMinValue').textContent = document.getElementById('soilHumidityMin').value + '%';
      document.getElementById('soilHumidityMaxValue').textContent = document.getElementById('soilHumidityMax').value + '%';
      
      // Temperatura
      document.getElementById('temperatureMinValue').textContent = document.getElementById('temperatureMin').value + '¬∞C';
      document.getElementById('temperatureMaxValue').textContent = document.getElementById('temperatureMax').value + '¬∞C';
      
      // Chuva
      const noRainDays = document.getElementById('noRainDays').value;
      document.getElementById('noRainDaysValue').textContent = noRainDays + (noRainDays == 1 ? ' dia' : ' dias');
      
      // Gases
      document.getElementById(\'inflammableGasThresholdValue\').textContent = document.getElementById(\'inflammableGasThreshold\').value + \'%\';
      document.getElementById(\'toxicGasThresholdValue\').textContent = document.getElementById(\'toxicGasThreshold\').value + \'%\';

      // Delay de Registro
      const delayConfig = document.getElementById(\'delayConfig\').value;
      document.getElementById(\'delayConfigValue\').textContent = delayConfig + (delayConfig == 1 ? \' minuto\' : \' minutos\');
    }

    // Fun√ß√£o para carregar configura√ß√µes do servidor
    async function loadSettings() {
      try {
        // Carregar configura√ß√µes de notifica√ß√£o
        const notificationResponse = await fetch(\"/api/notification-settings\", {
          method: \"GET\",
          credentials: \"include\"
        });

        if (notificationResponse.ok) {
          const settings = await notificationResponse.json();
          Object.keys(settings).forEach(key => {
            const element = document.getElementById(key);
            if (element) {
              if (element.type === \"checkbox\") {
                element.checked = settings[key];
              } else {
                element.value = settings[key];
              }
            }
          });
        }

        // Carregar configura√ß√£o de delay
        const delayResponse = await fetch(\"/api/delay-config\", {
          method: \"GET\",
          credentials: \"include\"
        });

        if (delayResponse.ok) {
          const delayData = await delayResponse.json();
          const delayElement = document.getElementById(\"delayConfig\");
          if (delayElement) {
            delayElement.value = delayData.delayConfig;
          }
        }
        
        updateRangeValues();
        showToast(\"Configura√ß√µes carregadas com sucesso!\", \"success\");

      } catch (error) {
        console.error(\"Erro ao carregar configura√ß√µes:\", error);
        applyDefaultSettings();
        showToast(\"Erro ao carregar configura√ß√µes. Usando padr√µes.\", \"error\");
      }
    }

    // Fun√ß√£o para aplicar configura√ß√µes padr√£o
    function applyDefaultSettings() {
      Object.keys(defaultSettings).forEach(key => {
        const element = document.getElementById(key);
        if (element) {
          if (element.type === 'checkbox') {
            element.checked = defaultSettings[key];
          } else {
            element.value = defaultSettings[key];
          }
        }
      });
      updateRangeValues();
    }

    // Fun√ß√£o para salvar configura√ß√µes
    async function saveSettings(formData) {
      try {
        const response = await fetch('/api/notification-settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify(formData)
        });

        if (response.ok) {
          showToast('Configura√ß√µes salvas com sucesso!', 'success');
          return true;
        } else {
          const error = await response.json();
          showToast('Erro ao salvar configura√ß√µes: ' + (error.error || 'Erro desconhecido'), 'error');
          return false;
        }
      } catch (error) {
        console.error('Erro ao salvar configura√ß√µes:', error);
        showToast('Erro de conex√£o ao salvar configura√ß√µes', 'error');
        return false;
      }
    }

    // Fun√ß√£o para apagar hist√≥rico
    async function clearHistory() {
      if (!confirm('Tem certeza que deseja apagar todo o hist√≥rico de dados? Esta a√ß√£o n√£o pode ser desfeita.')) {
        return;
      }

      try {
        const response = await fetch('/api/limpar-historico', {
          method: 'POST',
          credentials: 'include'
        });

        if (response.ok) {
          showToast('Hist√≥rico apagado com sucesso!', 'success');
        } else {
          const error = await response.json();
          showToast('Erro ao apagar hist√≥rico: ' + (error.error || 'Erro desconhecido'), 'error');
        }
      } catch (error) {
        console.error('Erro ao apagar hist√≥rico:', error);
        showToast('Erro de conex√£o ao apagar hist√≥rico', 'error');
      }
    }

    // Fun√ß√£o para redefinir senha
    async function resetPassword() {
      window.location.href = '/verificar.html';
        }

    // Fun√ß√£o para excluir conta
    async function deleteAccount() {
      if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Tem certeza que deseja excluir sua conta permanentemente?\n\nEsta a√ß√£o ir√°:\n- Apagar todos os seus dados\n- Remover seu hist√≥rico\n- Cancelar todas as configura√ß√µes\n\nEsta a√ß√£o N√ÉO PODE ser desfeita!')) {
        return;
      }

      const confirmation = prompt('Para confirmar a exclus√£o da conta, digite "EXCLUIR" (em mai√∫sculas):');
      if (confirmation !== 'EXCLUIR') {
        showToast('Exclus√£o cancelada', 'warning');
        return;
      }

      try {
        const response = await fetch('/api/delete-account', {
          method: 'DELETE',
          credentials: 'include'
        });

        if (response.ok) {
          showToast('Conta exclu√≠da com sucesso. Redirecionando...', 'success');
          setTimeout(() => {
            window.location.href = '/';
          }, 2000);
        } else {
          const error = await response.json();
          showToast('Erro ao excluir conta: ' + (error.error || 'Erro desconhecido'), 'error');
        }
      } catch (error) {
        console.error('Erro ao excluir conta:', error);
        showToast('Erro de conex√£o ao excluir conta', 'error');
      }
    }

    // Inicializa√ß√£o da p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      console.log('P√°gina de configura√ß√µes carregada');
      
      // Carregar configura√ß√µes do servidor
      loadSettings();
      
      // Adicionar event listeners para os ranges
      const ranges = document.querySelectorAll('input[type="range"]');
      ranges.forEach(range => {
        range.addEventListener('input', updateRangeValues);
      });
      
      // Event listener para o formul√°rio
      document.getElementById('configForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const settings = {};
        
        // Converter FormData para objeto
        for (let [key, value] of formData.entries()) {
          const element = document.getElementById(key);
          if (element && element.type === 'checkbox') {
            settings[key] = element.checked;
          } else if (element && (element.type === 'range' || element.type === 'number')) {
            settings[key] = parseInt(value);
          } else {
            settings[key] = value;
          }
        }
        
        // Adicionar checkboxes n√£o marcados (FormData n√£o inclui checkboxes desmarcados)
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
          if (!settings.hasOwnProperty(checkbox.name)) {
            settings[checkbox.name] = false;
          }
        });
        
        await saveSettings(settings);
      });
      
      // Event listener para restaurar padr√µes
      document.getElementById('resetBtn').addEventListener('click', function() {
        if (confirm('Tem certeza que deseja restaurar as configura√ß√µes padr√£o?')) {
          applyDefaultSettings();
          showToast('Configura√ß√µes padr√£o restauradas', 'success');
        }
      });
      
      // Event listeners para gerenciamento de conta
      document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);
      document.getElementById("resetPasswordBtn").addEventListener("click", resetPassword);
      document.getElementById("regenerateTokenBtn").addEventListener("click", regenerateToken);

    async function regenerateToken() {
      if (!confirm("Tem certeza que deseja regenerar seu token de acesso? O token atual ser√° invalidado.")) {
        return;
      }

      const token = getAuthToken();
      if (!token) {
        showToast("Voc√™ precisa estar logado para regenerar o token.", "warning");
        return;
      }

      try {
        const response = await fetch("/api/regenerate-token", {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        if (response.ok) {
          const result = await response.json();
          localStorage.setItem("jwt", result.token); // Atualiza o token no localStorage
          showToast("Token regenerado com sucesso!", "success");
        } else {
          const error = await response.json();
          showToast("Erro ao regenerar token: " + (error.error || "Erro desconhecido"), "error");
        }
      } catch (error) {
        console.error("Erro ao regenerar token:", error);
        showToast("Erro de conex√£o ao regenerar token.", "error");
      }
    }

    });
  </script>
</body>
</html>


    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const configForm = document.getElementById("configForm");
        const humidityMin = document.getElementById("humidityMin");
        const humidityMinValue = document.getElementById("humidityMinValue");
        const humidityMax = document.getElementById("humidityMax");
        const humidityMaxValue = document.getElementById("humidityMaxValue");
        const soilHumidityMin = document.getElementById("soilHumidityMin");
        const soilHumidityMinValue = document.getElementById("soilHumidityMinValue");
        const soilHumidityMax = document.getElementById("soilHumidityMax");
        const soilHumidityMaxValue = document.getElementById("soilHumidityMaxValue");
        const temperatureMin = document.getElementById("temperatureMin");
        const temperatureMinValue = document.getElementById("temperatureMinValue");
        const temperatureMax = document.getElementById("temperatureMax");
        const temperatureMaxValue = document.getElementById("temperatureMaxValue");

        // Fun√ß√£o para obter o token JWT do localStorage
        function getAuthToken() {
          return localStorage.getItem("jwt");
        }

        // Fun√ß√£o para exibir toasts
        function showToast(message, type = "info") {
          const toast = document.createElement("div");
          toast.classList.add("toast", type);
          toast.textContent = message;
          document.body.appendChild(toast);

          setTimeout(() => {
            toast.classList.add("show");
          }, 100);

          setTimeout(() => {
            toast.classList.remove("show");
            toast.addEventListener("transitionend", () => toast.remove());
          }, 3000);
        }
        window.showToast = showToast; // Tornar showToast global para push-frontend.js

        // Atualizar valores dos ranges
        const updateRangeValue = (input, output, suffix = "") => {
          output.textContent = input.value + suffix;
        };

        humidityMin.addEventListener("input", () => updateRangeValue(humidityMin, humidityMinValue, "%"));
        humidityMax.addEventListener("input", () => updateRangeValue(humidityMax, humidityMaxValue, "%"));
        soilHumidityMin.addEventListener("input", () => updateRangeValue(soilHumidityMin, soilHumidityMinValue, "%"));
        soilHumidityMax.addEventListener("input", () => updateRangeValue(soilHumidityMax, soilHumidityMaxValue, "%"));
        temperatureMin.addEventListener("input", () => updateRangeValue(temperatureMin, temperatureMinValue, "¬∞C"));
        temperatureMax.addEventListener("input", () => updateRangeValue(temperatureMax, temperatureMaxValue, "¬∞C"));

        // Carregar configura√ß√µes existentes
        async function loadConfigurations() {
          const token = getAuthToken();
          if (!token) {
            showToast("Voc√™ precisa estar logado para ver as configura√ß√µes.", "warning");
            return;
          }

          try {
            const response = await fetch("/api/user-settings", {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            });
            if (!response.ok) {
              throw new Error(`Erro HTTP: ${response.status}`);
            }
            const settings = await response.json();

            // Aplicar configura√ß√µes aos campos do formul√°rio
            document.getElementById("enableNotifications").checked = settings.enableNotifications === "true";
            document.getElementById("dailyReports").checked = settings.dailyReports === "true";
            document.getElementById("humidityAlertsEnabled").checked = settings.humidityAlertsEnabled === "true";
            document.getElementById("humidityMin").value = settings.humidityMin || 30;
            document.getElementById("humidityMax").value = settings.humidityMax || 80;
            document.getElementById("soilHumidityMin").value = settings.soilHumidityMin || 20;
            document.getElementById("soilHumidityMax").value = settings.soilHumidityMax || 90;
            document.getElementById("temperatureAlertsEnabled").checked = settings.temperatureAlertsEnabled === "true";
            document.getElementById("temperatureMin").value = settings.temperatureMin || 10;
            document.getElementById("temperatureMax").value = settings.temperatureMax || 35;
            document.getElementById("rainAlertsEnabled").checked = settings.rainAlertsEnabled === "true";
            document.getElementById("rainStartAlert").checked = settings.rainStartAlert === "true";
            document.getElementById("rainStopAlert").checked = settings.rainStopAlert === "true";
            document.getElementById("noRainDays").value = settings.noRainDays || 7;
            document.getElementById("gasAlertsEnabled").checked = settings.gasAlertsEnabled === "true";
            document.getElementById("inflammableGasThreshold").value = settings.inflammableGasThreshold || 20;
            document.getElementById("toxicGasThreshold").value = settings.toxicGasThreshold || 15;
            document.getElementById("criticalGasAlert").checked = settings.criticalGasAlert === "true";

            // Atualizar valores exibidos dos ranges
            updateRangeValue(humidityMin, humidityMinValue, "%");
            updateRangeValue(humidityMax, humidityMaxValue, "%");
            updateRangeValue(soilHumidityMin, soilHumidityMinValue, "%");
            updateRangeValue(soilHumidityMax, soilHumidityMaxValue, "%");
            updateRangeValue(temperatureMin, temperatureMinValue, "¬∞C");
            updateRangeValue(temperatureMax, temperatureMaxValue, "¬∞C");
            updateRangeValue(document.getElementById("noRainDays"), document.getElementById("noRainDaysValue"), " dias");
            updateRangeValue(document.getElementById("inflammableGasThreshold"), document.getElementById("inflammableGasThresholdValue"), "%");
            updateRangeValue(document.getElementById("toxicGasThreshold"), document.getElementById("toxicGasThresholdValue"), "%");

            showToast("Configura√ß√µes carregadas com sucesso!", "success");
          } catch (error) {
            console.error("Erro ao carregar configura√ß√µes:", error);
            showToast("Erro ao carregar configura√ß√µes.", "error");
          }
        }

        // Salvar configura√ß√µes
        configForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const token = getAuthToken();
          if (!token) {
            showToast("Voc√™ precisa estar logado para salvar as configura√ß√µes.", "warning");
            return;
          }

          const settings = {
            enableNotifications: document.getElementById("enableNotifications").checked,
            dailyReports: document.getElementById("dailyReports").checked,
            humidityAlertsEnabled: document.getElementById("humidityAlertsEnabled").checked,
            humidityMin: document.getElementById("humidityMin").value,
            humidityMax: document.getElementById("humidityMax").value,
            soilHumidityMin: document.getElementById("soilHumidityMin").value,
            soilHumidityMax: document.getElementById("soilHumidityMax").value,
            temperatureAlertsEnabled: document.getElementById("temperatureAlertsEnabled").checked,
            temperatureMin: document.getElementById("temperatureMin").value,
            temperatureMax: document.getElementById("temperatureMax").value,
            rainAlertsEnabled: document.getElementById("rainAlertsEnabled").checked,
            rainStartAlert: document.getElementById("rainStartAlert").checked,
            rainStopAlert: document.getElementById("rainStopAlert").checked,
            noRainDays: document.getElementById("noRainDays").value,
            gasAlertsEnabled: document.getElementById("gasAlertsEnabled").checked,
            inflammableGasThreshold: document.getElementById("inflammableGasThreshold").value,
            toxicGasThreshold: document.getElementById("toxicGasThreshold").value,
            criticalGasAlert: document.getElementById("criticalGasAlert").checked,
          };

          try {
            const response = await fetch("/api/user-settings", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(settings),
            });

            if (!response.ok) {
              throw new Error(`Erro HTTP: ${response.status}`);
            }

            const result = await response.json();
            showToast(result.message, "success");
          } catch (error) {
            console.error("Erro ao salvar configura√ß√µes:", error);
            showToast("Erro ao salvar configura√ß√µes.", "error");
          }
        });

        // Chamar loadConfigurations ao carregar a p√°gina
        loadConfigurations();

        // Inicializar o cliente de notifica√ß√µes push
        if (typeof PushNotificationClient !== 'undefined') {
          const pushClient = new PushNotificationClient();
          // Adicionar um bot√£o de teste de notifica√ß√£o se desejar
          // const testNotificationBtn = document.getElementById('testNotificationBtn');
          // if (testNotificationBtn) {
          //   testNotificationBtn.addEventListener('click', () => pushClient.testNotification());
          // }
        }
      });
    </script>
  </body>
</html>

