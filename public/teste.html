<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Log de Notifica√ß√µes - UMCAD</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --accent:#29b6f6;
      --glass: rgba(17,17,17,0.7);
      --panel:#111;
      --muted: #7edfff;
    }
    html,body{height:100%;margin:0;}
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      color: white;
      background: linear-gradient(to bottom right, #0e1522, #00616C);
      background-attachment: fixed;
      background-size: cover;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding: 28px 16px;
      box-sizing: border-box;
    }
    @media (max-width: 480px) {
      body { background: #0e1522; }
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: linear-gradient(180deg, rgba(17,17,17,0.55), rgba(17,17,17,0.65));
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      padding: 22px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
      backdrop-filter: blur(6px);
    }

    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }

    h1 {
      margin:0;
      font-size:1.25rem;
      color: var(--accent);
      font-weight:800;
    }

    .controls {
      display:flex;
      gap:8px;
      align-items:center;
    }

    .btn {
      appearance:none;
      border: none;
      background: var(--accent);
      color: #000;
      padding:8px 12px;
      border-radius:8px;
      font-weight:600;
      cursor:pointer;
    }
    .btn.secondary {
      background: transparent;
      color: var(--muted);
      border: 1px solid rgba(126,223,255,0.12);
    }

    .info {
      color: #cfeffd;
      font-size:0.95rem;
      margin-bottom:12px;
    }

    .tables-wrap {
      display:flex;
      gap:18px;
      align-items:flex-start;
      flex-wrap:wrap;
    }

    .panel {
      background: rgba(0,0,0,0.25);
      border-radius: 10px;
      padding: 12px;
      flex:1 1 580px;
      min-width:300px;
      border: 1px solid rgba(255,255,255,0.03);
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }

    thead th {
      text-align:left;
      padding:10px 8px;
      font-weight:700;
      color: var(--muted);
      background: rgba(26,26,26,0.5);
      border-radius:6px;
      position:sticky;
      top:0;
    }

    tbody td {
      padding:10px 8px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      color: #e6eef2;
    }

    tbody tr:hover td { background: rgba(255,255,255,0.02); }

    .small { font-size:13px; color:#bcdfe8; }

    .status-success { color: #4CAF50; font-weight:700; }
    .status-failed { color: #F44336; font-weight:700; }

    .center { text-align:center; }

    .footer {
      margin-top:16px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .back-btn {
      text-decoration:none;
      display:inline-block;
      padding:10px 14px;
      border-radius:8px;
      background:transparent;
      color:var(--muted);
      border:1px solid rgba(126,223,255,0.08);
      font-weight:600;
    }

    @media (max-width:860px){
      .tables-wrap{flex-direction:column;}
      .panel{flex:1 1 100%;}
    }
  </style>
</head>
<body>
  <div class="container" role="main">
    <header>
      <h1>üìã Log de Notifica√ß√µes</h1>
      <div class="controls">
        <button id="refreshBtn" class="btn secondary">üîÑ Atualizar</button>
        <button id="testBtn" class="btn">üß™ Testar</button>
      </div>
    </header>

    <div class="info" id="infoText">Carregando registros... (usu√°rio precisa estar autenticado)</div>

    <div class="tables-wrap">
      <section class="panel" aria-labelledby="detailed-title">
        <h2 id="detailed-title" style="margin:0 0 10px 0; font-size:1rem; color:var(--muted)">Registros Detalhados</h2>
        <div style="overflow:auto; max-height:420px;">
          <table id="detailedTable" aria-describedby="detailed-title">
            <thead>
              <tr>
                <th>Data / Hora</th>
                <th>T√≠tulo</th>
                <th>Mensagem</th>
                <th class="center">Status</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="4" class="center small">Carregando...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <aside class="panel" aria-labelledby="stats-title" style="flex:0 0 320px;">
        <h2 id="stats-title" style="margin:0 0 10px 0; font-size:1rem; color:var(--muted)">Estat√≠sticas (√∫ltimos dias)</h2>
        <div id="statsArea" class="small">
          Carregando estat√≠sticas...
        </div>
      </aside>
    </div>

    <div class="footer">
      <a href="index.html" class="back-btn">‚¨Ö Voltar</a>
      <div class="small" id="debugInfo"></div>
    </div>
  </div>

  <script>
    // Teste.html funcional:
    // - Tenta carregar logs detalhados em /api/notification-log (recommended)
    // - Se n√£o existir ou houver erro, cai em /api/notification-stats (agregado)
    // - Usa Bearer JWT salvo em localStorage ('jwt')
    // - Bot√µes: Atualizar e Testar notifica√ß√£o

    const detailedTableBody = document.querySelector('#detailedTable tbody');
    const statsArea = document.getElementById('statsArea');
    const infoText = document.getElementById('infoText');
    const debugInfo = document.getElementById('debugInfo');

    const jwtToken = localStorage.getItem('jwt') || '';

    function getAuthHeaders() {
      const headers = { 'Content-Type': 'application/json' };
      if (jwtToken) headers['Authorization'] = 'Bearer ' + jwtToken;
      return headers;
    }

    async function fetchJson(url, options = {}) {
      const res = await fetch(url, Object.assign({ headers: getAuthHeaders() }, options));
      if (res.status === 401 || res.status === 403) {
        throw new Error('N√£o autorizado. Fa√ßa login ou atualize o token.');
      }
      if (!res.ok) {
        const txt = await res.text().catch(()=>null);
        throw new Error('Erro na requisi√ß√£o: ' + res.status + (txt ? ' ‚Äî ' + txt : ''));
      }
      return res.json();
    }

    function renderEmptyDetailed(message) {
      detailedTableBody.innerHTML = `<tr><td colspan="4" class="center small">${escapeHtml(message)}</td></tr>`;
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

    // Render de registros detalhados (formato esperado: array de objetos com sent_at/title/body/success)
    function renderDetailed(records) {
      if (!Array.isArray(records) || records.length === 0) {
        renderEmptyDetailed('Nenhuma notifica√ß√£o encontrada.');
        return;
      }
      detailedTableBody.innerHTML = '';
      for (const r of records) {
        const date = r.sent_at || r.date || r.timestamp || r.sentAt || '-';
        const title = r.title || (r.data && r.data.type) || '-';
        const body = r.body || r.message || r.data?.message || '-';
        const success = (typeof r.success !== 'undefined') ? r.success : (r.result === 'ok' || r.result === true);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="small">${escapeHtml(date)}</td>
          <td>${escapeHtml(title)}</td>
          <td>${escapeHtml(body)}</td>
          <td class="center ${success ? 'status-success' : 'status-failed'}">${success ? 'Enviado' : 'Falhou'}</td>
        `;
        detailedTableBody.appendChild(tr);
      }
    }

    // Render de estat√≠sticas agregadas (formato: array com {date, total, successful, failed})
    function renderStats(stats) {
      if (!Array.isArray(stats) || stats.length === 0) {
        statsArea.textContent = 'Nenhuma estat√≠stica dispon√≠vel.';
        return;
      }
      let html = '<ul style="padding-left:16px;margin:0;">';
      for (const s of stats) {
        const d = s.date || s.sent_at || '-';
        html += `<li style="margin-bottom:8px;"><strong>${escapeHtml(d)}</strong> ‚Äî Total: ${s.total||0}, Enviadas: ${s.successful||0}, Falhas: ${s.failed||0}</li>`;
      }
      html += '</ul>';
      statsArea.innerHTML = html;
    }

    // Primeiro tenta endpoint detalhado, depois fallback para estat√≠sticas
    async function carregarLogs() {
      infoText.textContent = 'Carregando registros...';
      debugInfo.textContent = '';
      renderEmptyDetailed('Carregando...'); statsArea.textContent = 'Carregando estat√≠sticas...';

      try {
        // Tenta rota detalhada (voc√™ pode implementar no backend: SELECT * FROM notification_log WHERE user_email = ? ORDER BY sent_at DESC LIMIT 200)
        const detailed = await fetchJson('/api/notification-log');
        renderDetailed(detailed);
        infoText.textContent = 'Registros detalhados carregados.';
        debugInfo.textContent = 'Fonte: /api/notification-log';
      } catch (errDetailed) {
        // Se falhar, tenta estat√≠sticas agregadas
        console.warn('Falha ao carregar /api/notification-log, tentando /api/notification-stats ‚Äî', errDetailed);
        try {
          const stats = await fetchJson('/api/notification-stats');
          // Renderiza estat√≠sticas e limpa tabela detalhada informando que √© agrega√ß√£o
          renderStats(stats);
          renderEmptyDetailed('Exibindo dados agregados (n√£o h√° endpoint detalhado).');
          infoText.textContent = 'Exibindo estat√≠sticas agregadas.';
          debugInfo.textContent = 'Fonte: /api/notification-stats';
        } catch (errStats) {
          console.error('Erro ao carregar estat√≠sticas:', errStats);
          renderEmptyDetailed('Erro ao carregar notifica√ß√µes.');
          statsArea.textContent = 'Erro ao carregar estat√≠sticas.';
          infoText.textContent = 'Falha ao carregar logs. Verifique autentica√ß√£o e endpoints no servidor.';
          debugInfo.textContent = String(errStats.message || errStats);
        }
      }
    }

    // Bot√£o testar notifica√ß√£o: chama /api/test-notification (requer autentica√ß√£o)
    async function testNotification() {
      try {
        const res = await fetch('/api/test-notification', { method:'POST', headers: getAuthHeaders() });
        if (!res.ok) {
          const text = await res.text().catch(()=>null);
          throw new Error('Falha: ' + res.status + (text ? ' ‚Äî ' + text : ''));
        }
        const data = await res.json();
        alert('Teste enviado. Resultado: ' + JSON.stringify(data));
        carregarLogs(); // atualizar depois do teste
      } catch (err) {
        alert('Erro ao enviar notifica√ß√£o de teste:\n' + err.message);
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', carregarLogs);
    document.getElementById('testBtn').addEventListener('click', testNotification);

    // Inicializa ao carregar a p√°gina
    window.addEventListener('load', () => {
      // Mostra dica quando n√£o h√° JWT
      if (!jwtToken) {
        infoText.textContent = 'Nenhum token JWT encontrado em localStorage (chave "jwt"). Fa√ßa login para ver seus logs.';
      }
      carregarLogs();
    });
  </script>
</body>
</html>
